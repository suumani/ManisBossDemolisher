# Test Plan  
`docs/SystemSpecification/99_TestPlan.md`

**Version:** v0.2 (draft)  
**Status:** framework agreement phase  
**Scope:** Manis Boss Demolisher

---

## 0. 本書の位置づけ

本書は、Manis Boss Demolisher における  
**ゲーム挙動テストの設計方針・実装方式・運用ルール**を定義する。

本書は「テストケース集」ではなく、  
**テストをどう作り、どう合否を判断するかの枠組み**を示す。

本書に反するテスト実装は、たとえ動作していても不正とみなす。

---

## 1. 基本思想

### TP-POL-001: ゲームはイベント駆動システムである
Manis Boss Demolisher は、Factorio が提供する各種イベントを起点として動作する。

- ロケット発射
- 時間経過（1分 / 30分イベント）
- 撃破イベント

よって、テストも **イベント駆動の振る舞い**を主対象とする。

---

### TP-POL-002: 合否判定の主審は「世界状態」である
テストは以下の優先順位で合否を判断する。

1. **世界状態（最優先）**
   - 実体生成：`surface.find_entities_filtered`
   - 仮想化：`VirtualEntityManager` の状態
   - 抑止：個体数が増えていないこと
2. **内部状態（補助）**
   - storage の進行フラグ
   - 初回normal管理フラグ
   - メッセージ抑止用の時刻
3. **観測ログ（補助）**
   - 沈黙防止
   - 原因特定
   - 回帰の証拠

ログは必須だが、**上位レイヤーの合否をログのみに依存してはならない**。

---

### TP-POL-003: テストは仕様から起こす
- テストは必ず `SystemSpecification` の仕様IDを根拠とする
- 実装を読んでテストを書くことは禁止する

---

## 2. テスト実装方式（3分割）

本プロジェクトでは、以下 **3種類のテスト方式**を併用する。

---

### TP-MODE-001: 即時実行テスト（Command-driven / Stub-based）

**概要**
- テストコマンドで即時実行
- stub / fake を多用
- イベントや時間経過に依存しない

**目的**
- Export 選定
- Tier進行
- 初回normal判定
- cap計算・抑止判定

**合否判定**
- ORACLE-1（世界状態）または ORACLE-2（内部状態）
- ログは補助

---

### TP-MODE-002: 時間駆動テスト（Tick-driven / In-world）

**概要**
- 1分イベントを基準にシナリオを進行
- 実際のイベントフローを含めて検証

**目的**
- Export → Move の連動
- 30分スケジューラの挙動
- MovePlan の生成と消費
- 移動上限・抑止の確認

**合否判定**
- **世界状態監査が主**
- 内部状態・ログは補助

---

### TP-MODE-003: 混在テスト（Hybrid）

**概要**
- 即時実行で前提条件を構築
- その後、時間駆動で世界を動かす

**目的**
- 境界条件の再現（cap境界、初回normal境界など）
- 実プレイでは作りづらい状況の検証

---

## 3. 時間粒度とスケジューラ運用

### TP-TIME-001: 時間粒度
- テストは **1分イベント**を基本とする
- Factorio の早送り機能を前提に、実時間短縮は行わない

---

### TP-TIME-002: 30分スケジューラのテスト対応
- 30分イベントは **テストモードでは周期を短縮可能**とする
- 推奨：
  - スケジューラ周期を設定値で切替
  - テスト時は 1分周期として実行

※ コメントアウトによる切替は許容されるが、推奨しない。

---

## 4. テストシナリオのリセット戦略

### TP-RESET-001: 基本戦略
- **ゲーム起動 → 新規シナリオ開始 → テスト実行**
- 同一初期条件で実行できるテスト群を **Test Pack** としてまとめる

---

### TP-RESET-002: Test Pack
Test Pack は以下を定義する：

- 前提条件（新規シナリオ / 特定セーブ）
- 実行方法（コマンド）
- 合格条件（どの世界状態を監査するか）

---

### TP-RESET-003: 専用セーブの利用
以下の場合、**テスト専用セーブデータ**の再利用を許可する：

- APIからの環境構築が困難
- 特定の進行状態を再現する必要がある

---

## 5. 初期 Test Pack（たたき台）

### PACK-EXPORT-BASIC
**前提**
- 新規シナリオ

**対象**
- ロケット発射による Export 評価
- Vulcanus 特例
- Defeated 判定

**主オラクル**
- 世界状態（輸入先の実体 or 仮想個体）
- 補助：Exportログ

---

### PACK-MOVE-SCHEDULE
**前提**
- 新規シナリオ
- テストモードで 30分スケジューラ短縮

**対象**
- ロケット発射 → MovePlan生成
- 1分ごとの Move 実行
- Fatal系が移動しないこと

**主オラクル**
- 世界状態（位置変化、個体数）
- 補助：Moveログ

---

### PACK-EXPORT-CAP-EDGE
**前提**
- 専用セーブ（dest_surface が cap 直前）

**対象**
- cap 到達時の輸出抑止

**主オラクル**
- 世界状態（個体数が増えない）
- 補助：SKIPログ（CAP_REACHED）

---

## 6. テスト対象外（明示）

以下は自動テスト対象外とする：

- バランスの良し悪し
- プレイヤー心理
- UI 表示の細部

これらはプレイテストで担保する。

---

## 7. 低レイヤーテスト許可条件

### TP-LOW-ALLOW
低レイヤーの単体テストは、以下を **すべて満たす場合のみ**許可される：

1. 上位のゲーム挙動テストが FAIL した
2. 原因が低レイヤー処理に特定された
3. 再発防止が仕様として必要と判断された

---

## 8. 更新ルール

- 新しい仕様が追加された場合：
  - 本書に対応する Test Pack / シナリオを追加する
- テストが書けない仕様は：
  - 仕様側が未完成であると判断する

---

### まとめ

本テスト計画は、

> **「ゲームとしての正しさを、世界から検証する」**

ための枠組みである。

テストは、
**必要最小限・仕様準拠・世界監査主体**で追加される。

---