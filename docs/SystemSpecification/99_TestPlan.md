# Test Plan  
`docs/SystemSpecification/99_TestPlan.md`

**Version:** v0.2 (draft)  
**Status:** framework agreement phase  
**Scope:** Manis Boss Demolisher

---

## 0. 本書の位置づけ

本書は、Manis Boss Demolisher における  
**ゲーム挙動テストの設計方針・実装方式・運用ルール**を定義する。

本書は「テストケース集」ではなく、  
**テストをどう作り、どう合否を判断するかの枠組み**を示す。

本書に反するテスト実装は、たとえ動作していても不正とみなす。

---

## 1. 基本思想

### TP-POL-001: ゲームはイベント駆動システムである
Manis Boss Demolisher は、Factorio が提供する各種イベントを起点として動作する。

- ロケット発射
- 時間経過（1分 / 30分イベント）
- 撃破イベント

よって、テストも **イベント駆動の振る舞い**を主対象とする。

---

### TP-POL-002: 合否判定の主審は「世界状態」である
テストは以下の優先順位で合否を判断する。

1. **世界状態（最優先）**
   - 実体生成：`surface.find_entities_filtered`
   - 仮想化：`VirtualEntityManager` の状態
   - 抑止：個体数が増えていないこと
2. **内部状態（補助）**
   - storage の進行フラグ
   - 初回normal管理フラグ
   - メッセージ抑止用の時刻
3. **観測ログ（補助）**
   - 沈黙防止
   - 原因特定
   - 回帰の証拠

ログは必須だが、**上位レイヤーの合否をログのみに依存してはならない**。

---

### TP-POL-003: テストは仕様から起こす
- テストは必ず `SystemSpecification` の仕様IDを根拠とする
- 実装を読んでテストを書くことは禁止する

---

## 2. テスト実装方式（4分割）

本プロジェクトでは、以下 **4種類のテスト方式**を併用する。

---

### TP-MODE-001: 即時実行テスト（Command-driven / Stub-based）

**概要**
- テストコマンドで即時実行
- stub / fake を多用
- イベントや時間経過に依存しない
- 乱数制御は hook 経由

**目的**
- Export 選定
- Tier進行
- 初回normal判定
- cap計算・抑止判定

**合否判定**
- ORACLE-1（世界状態）または ORACLE-2（内部状態）
- ログは補助

---

### TP-MODE-002: 時間駆動テスト（Tick-driven / In-world）

**概要**
- 1分イベントを基準にシナリオを進行
- 実際のイベントフローを含めて検証

**目的**
- Export → Move の連動
- 30分スケジューラの挙動
- MovePlan の生成と消費
- 移動上限・抑止の確認

**合否判定**
- **世界状態監査が主**
- 内部状態・ログは補助

---

### TP-MODE-003: 混在テスト（Hybrid）

**概要**
- 即時実行で前提条件を構築
- その後、時間駆動で世界を動かす

**目的**
- 境界条件の再現（cap境界、初回normal境界など）
- 実プレイでは作りづらい状況の検証

---

### TP-MODE-004: 確率吸収テスト（Probabilistic Absorption）
**概要**
- 決定論的だが単発では観測できない挙動を対象とする
- Nステップ / Kプランの試行により結果を吸収する

**対象例**
- Move における Phys / Vir 遷移
- 距離ロール・セル順シャッフル
---

### TP-MODE-005: 時間遅延テスト（Deferred / Tick-bridged）

**概要**
- ゲームイベントが「次の tick」または「非同期処理後」に反映される挙動を検証する
- 即時 assert を行わず、Deferred Runner を介して検証を行う

**対象例**
- on_entity_died による Defeated フラグ更新
- 非同期 MovePlan 生成
- イベント連鎖（Export → Move）

**設計原則**
- tick を直接進める API は使用しない
- nth_tick をテストごとに乱立させない
- テスト基盤が **単一の tick pump** を管理する

**合否判定**
- 次 tick 以降の世界状態を主審とする
- ログは補助情報とする

**禁止事項**
- テスト内で独自に on_nth_tick を登録する
- 即時失敗を前提にした busy-wait / 多重 defer

---

## 3. 時間粒度とスケジューラ運用

### TP-TIME-001: 時間粒度
- テストは **1分イベント**を基本とする
- Factorio の早送り機能を前提に、実時間短縮は行わない

---

### TP-TIME-002: 30分スケジューラのテスト対応
- 30分イベントは **テストモードでは周期を短縮可能**とする
- 推奨：
  - スケジューラ周期を設定値で切替
  - テスト時は 1分周期として実行

※ コメントアウトによる切替は許容されるが、推奨しない。

---

## 4. テストシナリオのリセット戦略

### TP-RESET-001: 基本戦略
- **ゲーム起動 → 新規シナリオ開始 → テスト実行**
- 同一初期条件で実行できるテスト群を **Test Pack** としてまとめる

---

### TP-RESET-002: Test Pack
Test Pack は以下を定義する：

- 前提条件（新規シナリオ / 特定セーブ）
- 実行方法（コマンド）
- 合格条件（どの世界状態を監査するか）

---

### TP-RESET-003: 専用セーブの利用
以下の場合、**テスト専用セーブデータ**の再利用を許可する：

- APIからの環境構築が困難
- 特定の進行状態を再現する必要がある
- 専用 surface の生成
- Chunk 生成状態の制御
- VirtualEntityManager のクリア
- MovePlanStore 等、テスト所有一時状態のクリア

---

## 5. 初期 Test Pack（たたき台）

### PACK-EXPORT-BASIC
**前提**
- 新規シナリオ

**対象**
- ロケット発射による Export 評価
- Vulcanus 特例
- Defeated 判定

**主オラクル**
- 世界状態（輸入先の実体 or 仮想個体）
- 補助：Exportログ

---

### PACK-MOVE-SCHEDULE
**前提**
- 新規シナリオ
- テストモードで 30分スケジューラ短縮

**対象**
- ロケット発射 → MovePlan生成
- 1分ごとの Move 実行
- Fatal系が移動しないこと

**主オラクル**
- 世界状態（位置変化、個体数）
- 補助：Moveログ

**検証内容**
- Phys → Phys
- Phys → Vir
- Vir → Phys
- Vir → Vir
- 距離制約（1移動あたり）
---

### PACK-EXPORT-CAP-EDGE
**前提**
- 専用セーブ（dest_surface が cap 直前）

**対象**
- cap 到達時の輸出抑止

**主オラクル**
- 世界状態（個体数が増えない）
- 補助：SKIPログ（CAP_REACHED）

---

## 6. テスト対象外（明示）

以下は自動テスト対象外とする：

- バランスの良し悪し
- プレイヤー心理
- UI 表示の細部

これらはプレイテストで担保する。

---

## 7. 低レイヤーテスト許可条件

### TP-LOW-ALLOW
低レイヤーの単体テストは、以下を **すべて満たす場合のみ**許可される：

1. 上位のゲーム挙動テストが FAIL した
2. 原因が低レイヤー処理に特定された
3. 再発防止が仕様として必要と判断された

---

## 8. 更新ルール

- 新しい仕様が追加された場合：
  - 本書に対応する Test Pack / シナリオを追加する
- テストが書けない仕様は：
  - 仕様側が未完成であると判断する

---



## 9. テストとの関係

- 本書で定義された観測点は、
  `99_TestPlan.md` における **合否判定の根拠**となる
- 観測点の無い仕様は、テスト対象にしてはならない

---

## 10. テスト基盤設計ポリシー（確定）

本節は、Manis Boss Demolisher における
**テスト基盤そのものの設計思想**を記録する。

以後のテスト実装は、本節に反する形で行ってはならない。

---

### TP-INF-001: テストは「サブシステム」である

本プロジェクトにおいて、テストは一時的な補助物ではなく、
**独立したサブシステム**として扱う。

よって以下を原則とする：

- テスト用の設定・状態・実行制御は、責務分離されたクラス群で管理する
- 「最小で動かすための入口」「簡易overrideの寄せ集め」は採用しない
- テストコードは設計対象であり、即席実装を許可しない

---

### TP-INF-002: テスト基盤クラス群の役割分担

テストは以下の責務単位で構成される：

- **TestRuntime**
  - テストモードの有効/無効
  - 現在の Pack / Scenario の識別
  - スケジューラ周期など、実行環境の切替

- **TestConfig**
  - Pack/Scenario 単位の設定値（固定dest、固定pick 等）
  - テストが「何を期待するか」を表現する設定

- **TestHooks**
  - 本番コードがテストに協力するための唯一の窓口
  - 本番コードは storage を直接見てテスト分岐してはならない

- **WorldOracle**
  - テストの主オラクル
  - 世界状態（実体 / 仮想）を直接観測するためのAPI群

- **TestBootstrap**
  - Pack開始時の初期化
  - テスト所有の一時状態のみを安全にクリア

これらはすべて **tests/infrastructure** 配下に配置され、
本番の services 層とは明確に分離される。

---

### TP-INF-003: 合否判定の最優先は「世界状態」

テストの合否は、以下の優先順位で判断する：

1. **世界状態（最優先）**
   - surface.find_entities_filtered による実体監査
   - VirtualEntityManager による仮想状態監査

2. **内部状態（補助）**
   - storage 上の進行フラグ・抑止フラグ等

3. **ログ（補助）**
   - 観測性の保証
   - 原因特定
   - 回帰時の証跡

ログは必須であるが、
**上位レイヤーのテスト合否をログのみに依存してはならない**。

---

### TP-INF-004: テストは As-Is を尊重して設計する

テストは、常に以下の手順で設計される：

1. 既存コードの挙動（As-Is）を確認する
2. その理解をレビューし、認識を揃える
3. 仕様書を As-Is / To-Be の差分として更新する
4. その上でテストを実装する

仕様書に基づいて即座にコードを修正する行為は行わない。
As-Is 比較を省略したテスト設計は不正とみなす。

---

### TP-INF-005: テストは Pack 単位で構築する

テストは単体関数ではなく、
**意味のあるシナリオ群（Test Pack）**として構築する。

- Pack は同一初期条件（新規シナリオ / 専用セーブ）を共有する
- Pack 内のシナリオは、段階的に世界を変化させてもよい
- Pack 単位で実行・成功・失敗を判断する

例：
- PACK-EXPORT-BASIC
- PACK-MOVE-SCHEDULE
- PACK-EXPORT-CAP-EDGE

---

### TP-INF-006: 本番コードへのテスト協力は最小・明示的に行う

本番コードがテストに協力する場合：

- 直接 storage を参照してはならない
- 必ず TestHooks 経由で行う
- テスト無効時は完全に本番挙動となること

テストのために本番ロジックを複雑化させることは禁止する。

---

### TP-INF-007: 個別実装への逸脱を防ぐ

以下は明確に禁止する：

- テストごとに独自の override 実装を追加する
- 既存の TestInfrastructure をバイパスする
- その場しのぎの stub / mock を本番層に追加する

テストが書きにくい場合は、
**設計が不足している**と判断し、先に基盤を修正する。


---

### まとめ

本プロジェクトのテストは、

> 「仕様を守っているか」ではなく  
> **「世界が正しく変化しているか」**を検証する。

テスト基盤はそのための **正当な設計対象**であり、
短期的な便宜のために簡略化してはならない。

---